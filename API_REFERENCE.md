# API „É™„Éï„Ç°„É¨„É≥„Çπ

**o3-pro Azure OpenAI „ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà + Cosmos DBÂ±•Ê≠¥ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†**

---

## üìã Ê¶ÇË¶Å

„Åì„ÅÆ„Ç∑„Çπ„ÉÜ„É†„ÅØ„ÄÅAzure OpenAI„ÅÆo3-pro„É¢„Éá„É´„Çí‰ΩøÁî®„Åó„Åü„ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà„Å®„ÄÅAzure Cosmos DB„Çí‰ΩøÁî®„Åó„ÅüÂ±•Ê≠¥ÁÆ°ÁêÜÊ©üËÉΩ„ÇíÊèê‰æõ„Åó„Åæ„Åô„ÄÇ

### ‰∏ªË¶ÅÊ©üËÉΩ
- ‚úÖ o3-proÊé®Ë´ñ„É¢„Éº„ÉâÔºàlow/medium/high effortÔºâ
- ‚úÖ „Çπ„Éà„É™„Éº„Éü„É≥„Ç∞ÂøúÁ≠î
- ‚úÖ Azure Cosmos DBÂ±•Ê≠¥‰øùÂ≠ò
- ‚úÖ „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥Ê§úÁ¥¢
- ‚úÖ TTLÔºàËá™ÂãïÂâäÈô§ÔºâË®≠ÂÆö
- ‚úÖ „Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÂØæÂøú

---

## üöÄ „ÇØ„Ç§„ÉÉ„ÇØ„Çπ„Çø„Éº„Éà

### 1. Áí∞Â¢ÉË®≠ÂÆö

```bash
# 1. Python‰ªÆÊÉ≥Áí∞Â¢É
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate   # Windows

# 2. ‰æùÂ≠òÈñ¢‰øÇ„Ç§„É≥„Çπ„Éà„Éº„É´
pip install -r requirements.txt

# 3. Áí∞Â¢ÉÂ§âÊï∞Ë®≠ÂÆö
cp .env.cosmos .env  # Cosmos DBË®≠ÂÆö„Çí„Ç≥„Éî„Éº
# .env„Éï„Ç°„Ç§„É´„ÇíÁ∑®ÈõÜ„Åó„Å¶AzureË™çË®ºÊÉÖÂ†±„ÇíË®≠ÂÆö
```

### 2. AzureÁí∞Â¢ÉÊßãÁØâ

```bash
# Cosmos DB„Éá„Éó„É≠„Ç§
cd azure_templates
./deploy.sh

# ÁîüÊàê„Åï„Çå„ÅüË®≠ÂÆö„ÇíÁ¢∫Ë™ç
cat .env.generated
```

### 3. „ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„ÉàËµ∑Âãï

```bash
# „É°„Ç§„É≥„ÉÅ„É£„ÉÉ„Éà„Éú„ÉÉ„Éà
python simple_chatbot.py

# Â±•Ê≠¥Ê§úÁ¥¢„ÉÑ„Éº„É´
python cosmos_search.py --conversations
```

---

## üîß „Ç≥„Ç¢API

### AzureË™çË®º (`core/azure_auth.py`)

#### O3ProConfig
Azure OpenAIÊé•Á∂öË®≠ÂÆöÁÆ°ÁêÜ„ÇØ„É©„Çπ

```python
from core.azure_auth import O3ProConfig

config = O3ProConfig()
is_valid = config.validate()  # bool: Ë®≠ÂÆöÊ§úË®º
```

**Áí∞Â¢ÉÂ§âÊï∞**:
- `AZURE_OPENAI_API_KEY` - API„Ç≠„Éº
- `AZURE_OPENAI_ENDPOINT` - „Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàURL
- `AZURE_OPENAI_DEPLOYMENT_NAME` - „Éá„Éó„É≠„Ç§„É°„É≥„ÉàÂêç

#### O3ProClient
Azure OpenAI „ÇØ„É©„Ç§„Ç¢„É≥„Éà

```python
from core.azure_auth import O3ProClient

client = O3ProClient(config)
is_ready = client.is_ready()  # bool: Êé•Á∂öÁ¢∫Ë™ç

# Âü∫Êú¨Êé®Ë´ñ
response = client.basic_reasoning(
    messages=[{"role": "user", "content": "Ë≥™Âïè"}],
    effort="low"  # "low", "medium", "high"
)

# „Çπ„Éà„É™„Éº„Éü„É≥„Ç∞
for chunk in client.streaming_chat(messages):
    print(chunk.choices[0].delta.content, end="")
```

### Â±•Ê≠¥ÁÆ°ÁêÜ (`cosmos_history/`)

#### CosmosHistoryManager
Cosmos DBÂ±•Ê≠¥ÁÆ°ÁêÜ„É°„Ç§„É≥„ÇØ„É©„Çπ

```python
from cosmos_history.config import load_config_from_env
from cosmos_history.cosmos_client import CosmosDBClient
from cosmos_history.cosmos_history_manager import CosmosHistoryManager

# ÂàùÊúüÂåñ
config = load_config_from_env()
cosmos_client = CosmosDBClient(config.cosmos_db)
manager = CosmosHistoryManager(cosmos_client, "tenant_id", config)

# ‰ºöË©±‰ΩúÊàê
conversation = await manager.create_conversation(
    title="Êñ∞„Åó„ÅÑ‰ºöË©±",
    creator_user_id="user123"
)

# „É°„ÉÉ„Çª„Éº„Ç∏ËøΩÂä†
message = await manager.add_message(
    conversation_id=conversation.conversation_id,
    sender_user_id="user123",
    sender_display_name="„É¶„Éº„Ç∂„Éº",
    content="„Åì„Çì„Å´„Å°„ÅØ"
)

# ‰ºöË©±ÂèñÂæó
conversation = await manager.get_conversation(conversation_id)

# ‰ºöË©±‰∏ÄË¶ß
conversations = await manager.list_conversations(limit=20)

# „É°„ÉÉ„Çª„Éº„Ç∏ÂèñÂæó
messages = await manager.get_conversation_messages(conversation_id)

# Ê§úÁ¥¢
results = await manager.search_conversations(
    tenant_id="tenant_id",
    query="„Ç≠„Éº„ÉØ„Éº„Éâ",
    limit=10
)
```

### „Éá„Éº„Çø„É¢„Éá„É´ (`cosmos_history/models/`)

#### ChatConversation
‰ºöË©±„Éá„Éº„Çø„É¢„Éá„É´

```python
from cosmos_history.models.conversation import ChatConversation

conversation = ChatConversation(
    id="conv_001",
    tenant_id="tenant_001", 
    conversation_id="conv_001",
    title="‰ºöË©±„Çø„Ç§„Éà„É´",
    # ... „Åù„ÅÆ‰ªñ„ÅÆ„Éï„Ç£„Éº„É´„Éâ
)

# ËæûÊõ∏Â§âÊèõ
dict_data = conversation.to_dict()
cosmos_dict = conversation.to_cosmos_dict()

# Âæ©ÂÖÉ
conversation = ChatConversation.from_dict(dict_data)
conversation = ChatConversation.from_cosmos_dict(cosmos_dict)
```

#### ChatMessage
„É°„ÉÉ„Çª„Éº„Ç∏„Éá„Éº„Çø„É¢„Éá„É´

```python
from cosmos_history.models.message import ChatMessage

message = ChatMessage(
    id="msg_001",
    conversation_id="conv_001",
    tenant_id="tenant_001",
    sender=MessageSender(
        user_id="user123",
        display_name="„É¶„Éº„Ç∂„Éº",
        role="user"
    ),
    content=MessageContent(
        text="„É°„ÉÉ„Çª„Éº„Ç∏ÂÜÖÂÆπ",
        content_type="text"
    ),
    timestamp="2025-07-20T12:00:00.000Z"
)
```

---

## üîç Ê§úÁ¥¢API

### „Ç≥„Éû„É≥„Éâ„É©„Ç§„É≥Ê§úÁ¥¢ (`cosmos_search.py`)

```bash
# ‰ºöË©±‰∏ÄË¶ß
python cosmos_search.py --conversations

# „Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢
python cosmos_search.py --search "Ê§úÁ¥¢Ë™û"

# „É°„ÉÉ„Çª„Éº„Ç∏ÂÜÖÂÆπÊ§úÁ¥¢
python cosmos_search.py --message-search "ÂÜÖÂÆπ"

# ÁâπÂÆö‰ºöË©±„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
python cosmos_search.py --messages "conversation_id"

# Ë°®Á§∫‰ª∂Êï∞Âà∂Èôê
python cosmos_search.py --limit 50
```

### „Éó„É≠„Ç∞„É©„É†ÂÜÖÊ§úÁ¥¢

```python
# Ê§úÁ¥¢„Çµ„Éº„Éì„Çπ
from cosmos_history.search_service import SearchService

search = SearchService(cosmos_client, config)

# ‰ºöË©±Ê§úÁ¥¢
results = await search.search_conversations(
    tenant_id="tenant_001",
    query="Ê§úÁ¥¢Ë™û",
    filters={"status": "active"},
    limit=20
)

# „É°„ÉÉ„Çª„Éº„Ç∏Ê§úÁ¥¢
messages = await search.search_messages(
    tenant_id="tenant_001", 
    query="ÂÜÖÂÆπÊ§úÁ¥¢",
    conversation_id="conv_001"  # „Ç™„Éó„Ç∑„Éß„É≥
)
```

---

## ‚öôÔ∏è Ë®≠ÂÆöÁÆ°ÁêÜ

### Áí∞Â¢ÉÂ§âÊï∞Ë®≠ÂÆö (`.env.cosmos`)

```bash
# Azure Cosmos DB
COSMOS_DB_ENDPOINT=https://your-cosmos.documents.azure.com:443/
COSMOS_DB_API_KEY=your-primary-key
COSMOS_DB_DATABASE_NAME=chat_history_db
COSMOS_DB_CONVERSATIONS_CONTAINER=conversations
COSMOS_DB_MESSAGES_CONTAINER=messages

# TTLË®≠ÂÆö
ENABLE_TTL=true
CONVERSATION_TTL_SECONDS=-1        # -1 = Ê∞∏Á∂ö‰øùÂ≠ò
MESSAGE_TTL_SECONDS=-1             # -1 = Ê∞∏Á∂ö‰øùÂ≠ò
DEVELOPMENT_TTL_SECONDS=-1         # ÈñãÁô∫Áí∞Â¢ÉÁî®

# Âü∫Êú¨Ë®≠ÂÆö
DEFAULT_TENANT_ID=default_tenant
DEFAULT_USER_ID=default_user
DEVELOPMENT_MODE=true

# Azure OpenAI
AZURE_OPENAI_API_KEY=your-api-key
AZURE_OPENAI_ENDPOINT=https://your-openai.openai.azure.com/
AZURE_OPENAI_DEPLOYMENT_NAME=o3-pro
```

### „Éó„É≠„Ç∞„É©„É†Ë®≠ÂÆö

```python
from cosmos_history.config import load_config_from_env, AppConfig

# Áí∞Â¢ÉÂ§âÊï∞„Åã„ÇâË®≠ÂÆöË™≠„ÅøËæº„Åø
config = load_config_from_env()

# Ë®≠ÂÆöÊ§úË®º
is_valid, errors = config.validate_all()

# TTLË®≠ÂÆöÂèñÂæó
conversation_ttl = config.chat_history.get_conversation_ttl(
    development_mode=config.development.development_mode
)
```

---

## üéÆ „Éè„É≥„Éâ„É©„ÉºAPI

### Êé®Ë´ñ„Éè„É≥„Éâ„É©„Éº (`handlers/reasoning_handler.py`)

```python
from handlers import ReasoningHandler

handler = ReasoningHandler(client)

result = handler.process_with_reasoning(
    user_input="Ë≥™ÂïèÂÜÖÂÆπ",
    effort_level="medium",  # "low", "medium", "high"
    context_messages=[]     # ÈÅéÂéª„ÅÆ‰ºöË©±Â±•Ê≠¥
)

print(f"ÂõûÁ≠î: {result['content']}")
print(f"ÂÆüË°åÊôÇÈñì: {result['execution_time']}")
```

### „Çπ„Éà„É™„Éº„Éü„É≥„Ç∞„Éè„É≥„Éâ„É©„Éº (`handlers/streaming_handler.py`)

```python
from handlers import StreamingHandler

handler = StreamingHandler(client)

# „Çπ„Éà„É™„Éº„Éü„É≥„Ç∞ÂøúÁ≠î
for chunk in handler.stream_response(
    user_input="Ë≥™ÂïèÂÜÖÂÆπ",
    context_messages=[]
):
    print(chunk, end="", flush=True)
```

### „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Éè„É≥„Éâ„É©„Éº (`handlers/background_handler.py`)

```python
from handlers import BackgroundHandler

handler = BackgroundHandler(client)

# „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„ÉâÂá¶ÁêÜÈñãÂßã
job_id = handler.start_background_job(
    user_input="ÊôÇÈñì„ÅÆ„Åã„Åã„ÇãË≥™Âïè",
    effort_level="high"
)

# ÈÄ≤ÊçóÁ¢∫Ë™ç
status = handler.get_job_status(job_id)
if status["status"] == "completed":
    result = handler.get_job_result(job_id)
```

---

## üß™ „ÉÜ„Çπ„ÉàAPI

### „ÉÜ„Çπ„ÉàÂÆüË°å

```bash
# ÂÖ®„ÉÜ„Çπ„ÉàÂÆüË°å
python cosmos_history/tests/test_runner.py

# ÂÄãÂà•„ÉÜ„Çπ„Éà
python -m pytest cosmos_history/tests/test_models.py
python -m pytest cosmos_history/tests/test_cosmos_client.py
```

### „Éó„É≠„Ç∞„É©„É†„ÉÜ„Çπ„Éà

```python
# Ë®≠ÂÆöË®∫Êñ≠
from cosmos_history.cli_config import run_diagnostics
await run_diagnostics()

# Êé•Á∂ö„ÉÜ„Çπ„Éà
from cosmos_history.cosmos_client import test_cosmos_connection
await test_cosmos_connection()
```

---

## üö® „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞

### ÂÖ±ÈÄö„Ç®„É©„ÉºÂá¶ÁêÜ (`core/error_handler.py`)

```python
from core.error_handler import handle_api_error, CosmosDBError

try:
    # Cosmos DBÊìç‰Ωú
    result = await manager.create_conversation(...)
except CosmosDBError as e:
    handle_api_error(e, context="conversation_creation")
```

### „Ç´„Çπ„Çø„É†‰æãÂ§ñ

```python
# Cosmos DBÈñ¢ÈÄ£
from cosmos_history.cosmos_client import CosmosDBError, ConnectionError

# AzureË™çË®ºÈñ¢ÈÄ£
from core.azure_auth import AuthenticationError, ConfigurationError
```

---

## üìä „Éá„Éº„ÇøÁßªË°å

### JSON„Åã„ÇâCosmos DB„Å∏„ÅÆÁßªË°å

```python
from cosmos_history.migration_service import MigrationService

migration = MigrationService(cosmos_client, config)

# ÁßªË°åÂÆüË°å
result = await migration.migrate_from_json(
    json_file_path="chat_history/sessions.json",
    tenant_id="default_tenant",
    dry_run=False  # True: ÁßªË°å‰∫àË°åÊºîÁøí
)

print(f"ÁßªË°åÂÆå‰∫Ü: {result.migrated_count}‰ª∂")
```

---

## üîí „Çª„Ç≠„É•„É™„ÉÜ„Ç£

### Ë™çË®ºÊñπÂºè

1. **API KeyË™çË®º** (Êé®Â•®„ÉªÁ∞°Âçò)
2. **Azure ADË™çË®º** (Enterprise)
3. **Managed Identity** (AzureÁí∞Â¢É)

### TTLÔºàËá™ÂãïÂâäÈô§Ôºâ

```python
# TTLË®≠ÂÆö‰æã
CONVERSATION_TTL_SECONDS=2592000  # 30Êó•ÂæåÂâäÈô§
MESSAGE_TTL_SECONDS=7776000       # 90Êó•ÂæåÂâäÈô§
DEVELOPMENT_TTL_SECONDS=-1        # ÈñãÁô∫Áí∞Â¢É„ÅØÊ∞∏Á∂ö‰øùÂ≠ò
```

### „Éá„Éº„Çø„Éó„É©„Ç§„Éê„Ç∑„Éº

- „ÉÜ„Éä„É≥„ÉàÂàÜÈõ¢„Åß„Éû„É´„ÉÅ„ÉÜ„Éä„É≥„ÉàÂØæÂøú
- „É¶„Éº„Ç∂„ÉºIDÂà•„Ç¢„ÇØ„Çª„ÇπÂà∂Âæ°
- Ê§úÁ¥¢ÂèØËÉΩ„Éï„Ç£„Éº„É´„Éâ„ÅÆÂà∂Èôê

---

## üìà „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ

### „Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÊúÄÈÅ©Âåñ

```sql
-- Cosmos DB SQL API
SELECT * FROM c 
WHERE c.tenantId = "tenant_001" 
AND c.timeline.lastMessageAt > "2025-01-01"
ORDER BY c.timeline.lastMessageAt DESC
```

### „Éê„ÉÉ„ÉÅÂá¶ÁêÜ

```python
# Â§ßÈáè„Éá„Éº„ÇøÂá¶ÁêÜ
batch_size = 100
for batch in migration.get_batches(data, batch_size):
    await migration.process_batch(batch)
```

---

## üõ†Ô∏è „Éà„É©„Éñ„É´„Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞

### „Çà„Åè„ÅÇ„ÇãÂïèÈ°å

1. **Êé•Á∂ö„Ç®„É©„Éº**
   ```bash
   python cosmos_history/cli_config.py diagnostics
   ```

2. **TTL„Ç®„É©„Éº** 
   - TTLÂÄ§„Çí -1 „Åæ„Åü„ÅØÊ≠£„ÅÆÊï¥Êï∞„Å´Ë®≠ÂÆö

3. **Ë™çË®º„Ç®„É©„Éº**
   - API Key„Å®„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÇíÁ¢∫Ë™ç

4. **Bicep„Éá„Éó„É≠„Ç§„Ç®„É©„Éº**
   - ARM„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩøÁî® (`azure_templates/deploy.sh`)

### „É≠„Ç∞Á¢∫Ë™ç

```python
import logging
logging.basicConfig(level=logging.DEBUG)

# Cosmos DB„É≠„Ç∞
cosmos_logger = logging.getLogger('azure.cosmos')
cosmos_logger.setLevel(logging.INFO)
```

---

## üìö Èñ¢ÈÄ£„Éâ„Ç≠„É•„É°„É≥„Éà

- [AzureÁí∞Â¢É„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Ç¨„Ç§„Éâ](AZURE_SETUP_GUIDE.md)
- [Ë®≠ÂÆö„Ç¨„Ç§„Éâ](CONFIG_SETUP_GUIDE.md)
- [Cosmos DBË®≠Ë®à‰ªïÊßò](COSMOS_DB_DESIGN_SPECIFICATION.md)
- [„É¢„Ç∏„É•„Éº„É´‰ªïÊßòÊõ∏](MODULE_SPECIFICATIONS.md)
- [„Éï„Ç°„Ç§„É´Áä∂Ê≥Å„Ç¨„Ç§„Éâ](FILE_STATUS_GUIDE.md)

---

**„Åì„ÅÆAPI„É™„Éï„Ç°„É¨„É≥„Çπ„ÅØÂãï‰ΩúÁ¢∫Ë™çÊ∏à„Åø„ÅÆÊ©üËÉΩ„ÅÆ„Åø„ÇíË®òËºâ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ**